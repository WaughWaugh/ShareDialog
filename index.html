<!DOCTYPE html>
<html>
    <head>
        <title></title>
      
        <link rel="stylesheet" href="css/uikit.min.css" />
        <link rel="stylesheet" href="custom/css/theme.css" />
        
        <script src="js/jquery.min.js"></script>
		<script src="js/uikit.min.js"></script>
		<script src="js/handlebars.min.js"></script>
		
		<script type="text/javascript">
			function showExpandedView() {
				$(".mpl-simple-sharing-view").hide();
				$(".mpl-advanced-sharing-view").show();
			}
			function showSimpleView() {
				$(".mpl-simple-sharing-view").show();
				$(".mpl-advanced-sharing-view").hide();
			}
			function updateCount() {
				var count = $('#userPermissionsTable tbody tr').length;
				$('#numberOfSharedUsers').text(count);
			}
			function enableSaveChanges() {
				$('#shareButton').text('Save changes');
				$('#shareUserEmail').attr('disabled', true);
				$('#shareUserEditPermissions').attr('disabled', true);
				hideEmailValidationMessage();

			}

			function saveChanges() {
				$('#userPermissionsTable tr :disabled').closest('tr').remove();
				var user = $('#shareUserEmail').val();
				if (user.length > 0) {
					$('#shareButton').text('Share');
				} else {
					$('#shareButton').text('Done');
				}
				updateCount();
				$('#shareUserEmail').attr('disabled', false);
				$('#shareUserEditPermissions').attr('disabled', false);
			}

			function addUserPermissionChecboxAction() {
				$('.mpl-user-perm-table-row-action-item-checkbox').on('change', function(){
					enableSaveChanges();
				})
			}

			function isValidEmail(email) {
			    var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
			    //[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?
			    return re.test(email);
			} 

			function hideEmailValidationMessage() {
				$('.mpl-email-validation').hide();	
				$('#shareUserEmail').removeClass('uk-form-danger');	
				$('#shareUserEmail').removeClass('uk-form-success');
			}

			function showEmailValidationSuccess(numberOfEmails) {
				$('#shareUserEmail').removeClass('uk-form-danger');
				$('#shareUserEmail').addClass('uk-form-success');
				$('.mpl-email-validation').removeClass('uk-alert-danger');
				$('.mpl-email-validation').addClass('uk-alert-success');
				$('.mpl-email-validation').text('Successfully shared with ' + numberOfEmails + ' people');
				$('.mpl-email-validation').show();
				setTimeout(function(){
					$('#shareUserEmail').removeClass('uk-form-success');
					$('.mpl-email-validation').addClass('uk-animation-reverse').hide();
				}, 3000);
			}

			function showEmailValidationError() {
				$('#shareUserEmail').removeClass('uk-form-success');
				$('#shareUserEmail').addClass('uk-form-danger');
				$('.mpl-email-validation').removeClass('uk-alert-success');
				$('.mpl-email-validation').addClass('uk-alert-danger');
				$('.mpl-email-validation').text('Please enter valid email address')
				$('.mpl-email-validation').show();
			}

			function validateEmail(emails) {
				var length = emails.length;
				for(var i = 0; i < length; i++) {
					if (!isValidEmail(emails[i])) {
						return false;
					}
				}
				return true;
			}
			//This should go in init
			$(document).ready(function() {

				var data = {
					user:[{
						name: 'tintin@herge.com',
						canEdit: true
					},{
						name: 'haddock@marlinspike.com'
					}]
				};
				var source = $('#user-perm-table-template').html();
				var template = Handlebars.compile(source);
				$('#user-perm-table-container').html(template(data));
				hideEmailValidationMessage();
				

				$("#userPermissionsTable").on('click', '.mpl-permissions-remove', function(){
					var row = $(this).closest('tr');
					row.attr("disabled", true);
					$(row).find('.mpl-user-perm-table-row-action-item').prop('disabled', true);
					enableSaveChanges();
					//updateCount();
				});

				$('.mpl-user-perm-table-row-action-item-checkbox').on('change', function(){
					enableSaveChanges();
				})

				$('#shareUserEmail').on('keyup', function(){
					if (this.value.length > 0) {
						$('#shareButton').text('Share');
						$("#shareUserEditPermissions").prop('disabled', false);
					} else {
						$('#shareUserEditPermissions').prop("checked", false);
						$("#shareUserEditPermissions").prop('disabled', true);
					} 
					hideEmailValidationMessage();
				});

				$('#shareUserEmail').on('click', function(){
					hideEmailValidationMessage();		
				});

				$('#shareButton').on('click', function(){
					if ($('#shareButton').text() === "Share") {
						var users = $('#shareUserEmail').val();
						if (users.length === 0) return;

						var emails=users.replace(/[\s,]+/g, " ").replace(/[\s;]+/g, " ").toLowerCase().split(" ");
						var editPermissions = $('#shareUserEditPermissions').is(":checked");
						var numberOfEmails = emails.length;

						var checkIfAllValidEmails = validateEmail(emails);
						
						if (checkIfAllValidEmails === false) {
							showEmailValidationError();
							return;
						} else {
							showEmailValidationSuccess(numberOfEmails);
							for(var i = 0; i < numberOfEmails; i++) {

							var userLabel = "<label class='mpl-user-perm-table-row-action-item'>" + emails[i] + "</label>";
							var editCheckbox;

							if (editPermissions === true) {
								editCheckbox = "<input type='checkbox' class='mpl-user-perm-table-row-action-item mpl-user-perm-table-row-action-item-checkbox' checked> Can edit";
							} else {
								editCheckbox = "<input type='checkbox' class='mpl-user-perm-table-row-action-item mpl-user-perm-table-row-action-item-checkbox'> Can edit";
							}

							$('#userPermissionsTable').append("<tr>"+ "<td>" + userLabel + "</td>"+ 
							"<td>" + editCheckbox + "</td>"+ 
							"<td><button class='uk-button mpl-permissions-remove mpl-user-perm-table-row-action-item'><i class='uk-icon-trash-o' /> Remove</button></td>" +
							"</tr>");

							addUserPermissionChecboxAction();
							}
						}

						
						

						$('#shareUserEmail').val('');
						$('#shareUserEditPermissions').prop("checked", false);
						$('#shareButton').text('Done');

						updateCount();

					} else if ($('#shareButton').text() === "Done") {
						$('#shareButton').text('Share');
						$('#shareButton').addClass('uk-modal-close');
						
					} else if ($('#shareButton').text() === "Save changes"){
						saveChanges();
					}
					
				});

				$("#shareDialog").on('hide.uk.modal', function() {
					$('#shareButton').removeClass('uk-modal-close');
				})

				$("#shareDialog").on('show.uk.modal', function() {
					console.log("Shown");
				})

				

				updateCount();
				$("#shareUserEditPermissions").prop('disabled', true);
			})
		</script>

		<script id="user-perm-table-template" type="text/x-handlebars-template">
	    	<table class="uk-table uk-table-striped" id="userPermissionsTable">
	    		<thead>
					<tr>
						<th>User</th>
						<th>Permissions</th>
					</tr>
				</thead>
				<tbody>
					{{#each user}}
					<tr>
						<td><label class="mpl-user-perm-table-row-action-item">{{name}}</label></td>
						{{#if canEdit}}
							<td><input type="checkbox" class="mpl-user-perm-table-row-action-item mpl-user-perm-table-row-action-item-checkbox" checked > Can edit</td>
						{{else}}
							<td><input type="checkbox" class="mpl-user-perm-table-row-action-item mpl-user-perm-table-row-action-item-checkbox" > Can edit</td>
						{{/if}}
						<td><button class="uk-button mpl-permissions-remove mpl-user-perm-table-row-action-item" ><i class="uk-icon-trash-o" /> Remove</button></td>
					</tr>
					{{/each}}
				</tbody>
	    	</table>

    	</script>
		
    </head>
    <body>
   
		

    <div class="uk-width-medium-1-2 uk-container-center ">
		<button class="uk-button" data-uk-modal="{target:'#shareDialog'}">
			<i class="uk-icon-share-alt"></i>
			<span class="uk-hidden-small mpl-icon-text-padding">share</span>
		</button>
	</div>
	

 		<div id="shareDialog" class="uk-modal">
		    <div class="uk-modal-dialog">
		    	<button type="button" class="uk-modal-close uk-close"></button>
				<div class="uk-modal-header">
				    <h4>Share with others <img src="images/help_green.png"/></h4>
				</div>
		    	<div class="uk-form uk-form-horizontal">
		            <fieldset class="uk-form-controls-condensed" data-uk-margin>
		                <div class="uk-form-row">
	                        <input type="text" class="uk-form-large uk-width-1-1" id="shareUserEmail" placeholder="Enter email addresses" />
		                </div>
		                <div class="uk-form-row uk-text-right">
		                	 <span class="uk-alert mpl-email-validation uk-animation-fade " style="float:left; display: none;"></span>
		                	 <label class="uk-form-large uk-width-1-6"><input type="checkbox" id="shareUserEditPermissions" > Can edit</label>
		                </div>
		                <div class="uk-form-row uk-margin-small-top mpl-simple-sharing-view">
		                	<span>
		                	<label class="uk-form-label" style="width: 100%;">Shared with <span id="numberOfSharedUsers"></span> people <a onclick="showExpandedView()">Show</a></label>
		                	</span>
		            	</div>
		                <div class="uk-form-row mpl-advanced-sharing-view" style="display: none;">
		                	<label class="uk-form-label" style="width: 100%;">Shared with these people <a onclick="showSimpleView()">Hide</a></label>
		                </div>
		                <div class="uk-form-row mpl-advanced-sharing-view" style="display: none;">
		                	<div class="uk-container" id="user-perm-table-container" style="height:200px;overflow:scroll;">
			                	<!-- <table class="uk-table uk-table-striped" id="userPermissionsTable">
			                			<thead>
			                				<tr>
			                					<th>User</th>
			                					<th>Permissions</th>
			                				</tr>
			                			</thead>
	                                   <tbody>
	                                    <tr>
	                                        <td><label class="mpl-user-perm-table-row-action-item">Mishal Sanghvi</label></td>
	                                        <td><input type="checkbox" class="mpl-user-perm-table-row-action-item mpl-user-perm-table-row-action-item-checkbox" checked > Can edit</td>
	                                        <td><button class="uk-button mpl-permissions-remove mpl-user-perm-table-row-action-item" ><i class="uk-icon-trash-o" /> Remove</button></td>
	                                    </tr>
	                                    <tr>
	                                        <td><label class="mpl-user-perm-table-row-action-item">Rahul Saurav</label></td>
	                                        <td><input type="checkbox" class="mpl-user-perm-table-row-action-item mpl-user-perm-table-row-action-item-checkbox"> Can edit</td>
	                                        <td><button class="uk-button mpl-permissions-remove mpl-user-perm-table-row-action-item" ><i class="uk-icon-trash-o" /> Remove</button></td>
	                                    </tr>
	                                </tbody>
	                            </table> -->
                            </div>
		                </div>
		              
		                <div class="uk-modal-footer uk-text-right">
		                    <button class="uk-button uk-modal-close">Cancel</button>
		                    <button class="uk-button uk-button-primary" id="shareButton">Share</button>
		                </div>
		            </fieldset>
		        </div>
		    </div>
   		</div>
    </body>
</html>
